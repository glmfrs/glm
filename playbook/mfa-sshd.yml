---
- name: MFA installation du depot EPEL
  yum:
    name: epel-release
    state: latest
    update_cache: yes

- name: MFA installation du paquet
  yum:
    name:
      - google-authenticator
      - qrencode
    state: latest
    update_cache: yes

- name: MFA creation d'un OTP
  debug:
    msg: "google-authenticator doit être exécuter pour créer un OTP"

- name: MFA modification PAM
  lineinfile:
    path: /etc/pam.d/sshd
    line: auth required pam_google_authenticator.so
    insertafter: EOF

# - name: MFA modification PAM 
#   lineinfile:
#     path: /etc/pam.d/sshd
#     regexp: '^auth       substack     password-auth'
#     line: '# auth       substack     password-auth'

- name: MFA modification SSHD ChallengeResponseAuthentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^ChallengeResponseAuthentication'
    line: ChallengeResponseAuthentication yes

- name: MFA SSHD redemarrage
  systemd:
    name: sshd
    state: restarted
    enabled: yes
    masked: no
    daemon_reload: yes